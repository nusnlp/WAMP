var CompareRanges={START_TO_START:0,START_TO_END:1,END_TO_END:2,END_TO_START:3};var NodeType={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};var KeyCode={BACKSPACE:8,CAPS_LOCK:20,COMMA:188,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38};function debug(){if(typeof console!="undefined"){console.log.apply(this,arguments)}}(function(c){var a=[];function b(g){g.preventDefault();g.stopPropagation();for(var e=0;e<a.length;e++){var f=a[e];var d=c(f).data("drag-offsetX");var h=c(f).data("drag-offsetY");c(f).css({top:g.pageY+h+"px",left:g.pageX+d+"px"})}}jQuery.fn.startDrag=function(f){f.preventDefault();if(a.length==0){c(document).bind("mousemove",b)}for(var d=0;d<this.length;d++){var e=this.get(d);var g=c(e).offset();if(c(e).data("drag-offsetX")===undefined){c(e).data("drag-offsetX",g.left-f.pageX)}if(c(e).data("drag-offsetY")===undefined){c(e).data("drag-offsetY",g.top-f.pageY)}a.push(this.get(d))}};jQuery.fn.stopDrag=function(){var d=this;a=jQuery.grep(a,function(f,e){if(d.index(f)==-1){return true}else{c(f).removeData("drag-offsetX");c(f).removeData("drag-offsetY");return false}});if(a.length==0){c(document).unbind("mousemove",b)}};jQuery.fn.ancestorOf=function(d){var e=this.get(0);if(e&&d&&e.childNodes&&e.childNodes.length>0){if(document.documentElement.compareDocumentPosition){return !!(e.compareDocumentPosition(d)&16)}else{if(e.contains&&d.contains){return(e.contains(d)&&e!=d)}else{do{d=d.parentNode;if(d==e){return true}}while(d)}}}return false};jQuery.fn.hasAnyClass=function(e){for(var f=0;f<this.length;f++){for(var d=0;d<e.length;d++){if(c(this[f]).hasClass(e[d])){return true}}}return false}})(jQuery);XMLTools={};XMLTools.xmlToString=function(a){if(typeof XMLSerializer!="undefined"){return(new XMLSerializer()).serializeToString(a)}else{if(a.xml){return a.xml}else{throw"serialize is not supported or can't serialize "+a}}};XMLTools.stringToXML=function(b){var a;if(document.implementation.createDocument){var c=new DOMParser();a=c.parseFromString(b,"text/xml")}else{if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLDOM");a.async="false";a.loadXML(b)}}return a};XMLTools.loadXMLDoc=function(b){var a;if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLDOM")}else{if(document.implementation&&document.implementation.createDocument){a=document.implementation.createDocument("","",null)}else{alert("Your browser cannot handle this script")}}a.async=false;a.load(b);return(a)};Whitespace=function(a){if(!a){a="\n\r\t "}this.whitespace=a};Whitespace.prototype.ltrim=function(a){return a.replace(new RegExp("^["+this.whitespace+"]+"),"")};Whitespace.prototype.rtrim=function(a){return a.replace(new RegExp("["+this.whitespace+"]+$"),"")};Whitespace.prototype.trim=function(a){return this.ltrim(this.rtrim(a))};Whitespace.prototype.isWhitespace=function(a){return !(new RegExp("[^"+this.whitespace+"]+").test(a))};Whitespace.prototype.snapForward=function(b,a){while(a<b.length-1&&this.isWhitespace(b.charAt(a))){a++}return a};Whitespace.prototype.snapBackward=function(b,a){while(a>0&&this.isWhitespace(b.charAt(a-1))){a--}return a};Whitespace.prototype.condense=function(a){return a.replace(new RegExp("["+this.whitespace+"]+","g")," ")};Whitespace.prototype.condenseOffset=function(d,c){var a=0;for(var b=0;b<c&&b<d.length;b++){if(this.isWhitespace(d.charAt(b))){while(b+1<d.length&&this.isWhitespace(d.charAt(b+1))){b++}}a++}return a};Whitespace.prototype.uncondenseOffset=function(d,a){var c=0;for(var b=0;b<a&&b<d.length;b++){if(this.isWhitespace(d.charAt(c))){while(c<d.length&&this.isWhitespace(d.charAt(c))){c++}}else{c++}}return c};Locator=function(a,b){this.settings=jQuery.extend({normaliseClasses:[],ignoreClasses:[],whitespace:undefined},b);this.rootNode=a;this.whitespace=new Whitespace(this.settings.whitespace)};Locator.prototype.canIgnore=function(a){if((a.nodeType==NodeType.TEXT_NODE&&this.whitespace.isWhitespace(a.data))||(a.nodeType==NodeType.ELEMENT_NODE&&$(a).hasAnyClass(this.settings.ignoreClasses))||(a.nodeType!=NodeType.TEXT_NODE&&a.nodeType!=NodeType.ELEMENT_NODE)){return true}else{return false}};Locator.prototype.canNormalise=function(b,a){if(b.nodeType==NodeType.TEXT_NODE||$(b).hasAnyClass(this.settings.normaliseClasses)){if(a==null||(a.nodeType==NodeType.TEXT_NODE||$(a).hasAnyClass(this.settings.normaliseClasses))){return true}else{return false}}else{return false}};Locator.prototype.getNodeText=function(b){if(b.nodeType==NodeType.TEXT_NODE){return b.data}else{if(b.nodeType==NodeType.ELEMENT_NODE&&!$(b).hasAnyClass(this.settings.ignoreClasses)){var c="";for(var a=0;a<b.childNodes.length;a++){c+=this.getNodeText(b.childNodes[a])}return c}else{return""}}};Locator.prototype.getAddressFromNodeOffset=function(c,f){var j="";var h="";if($(this.rootNode).ancestorOf(c)==false&&this.rootNode!=c){return false}var d=c,b=f;if(d.nodeType==NodeType.ELEMENT_NODE&&b<d.childNodes.length){d=d.childNodes[b];b=0}while(d!=this.rootNode){if(d.nodeType==NodeType.ELEMENT_NODE&&(this.canIgnore(d)||$(d).is(":input"))){f=$(d.parentNode.childNodes).index(d);c=d.parentNode}b=$(d.parentNode.childNodes).index(d);d=d.parentNode}if(c.nodeType==NodeType.TEXT_NODE){if((this.whitespace.isWhitespace(c.data)||f<this.whitespace.rtrim(c.data).length)){h=c.data.substring(0,f);f=$(c.parentNode.childNodes).index(c);c=c.parentNode}else{f=$(c.parentNode.childNodes).index(c)+1;c=c.parentNode}}while(c!=this.rootNode&&f==c.childNodes.length){f=$(c.parentNode.childNodes).index(c)+1;c=c.parentNode}while((f<c.childNodes.length&&this.canNormalise(c.childNodes[f]))||((f==c.childNodes.length||f==0)&&this.canNormalise(c))){for(var g=f-1;g>=0;g--){var e=c.childNodes[g];if(this.canNormalise(e)){h=this.getNodeText(e)+h;f=g}else{if(e.nodeType!=NodeType.TEXT_NODE&&this.canIgnore(e)){f=g}else{break}}}if(f==0&&this.canNormalise(c)){f=$(c.parentNode.childNodes).index(c);c=c.parentNode}else{break}}var l=this.whitespace.condense(this.whitespace.ltrim(h)).length;if(l>0){j="."+l+j}do{var k=0;var a=null;for(var g=0;g<f;g++){var e=c.childNodes[g];if(this.canIgnore(e)){continue}else{if(a&&this.canNormalise(e,a)){a=e;continue}else{a=e;k++}}}if(j.length>0||k>0){j="/"+k+j}f=$(c.parentNode.childNodes).index(c);c=c.parentNode}while($(this.rootNode).ancestorOf(c)||this.rootNode==c);if(j.length==0){j="/0"}return j};Locator.prototype.getNodeOffsetFromAddress=function(k){var c=document.documentElement;var e=[];var d=0;k=String(k);if(k==""){return{node:this.rootNode,offset:0}}if(k.lastIndexOf(".")>0){var l=k.split(".");k=l[0];d=Number(l[1])}c=this.rootNode;e=k.split("/");e.shift();for(var f=0;f<e.length;f++){var g=this;var a=null;var m=$(c.childNodes).filter(function(){var i=this;if(g.canIgnore(i)){return false}else{if(a&&g.canNormalise(i,a)){a=i;return false}else{a=i;return true}}});if(m.length<=e[f]){return{node:c,offset:c.childNodes.length}}else{if(f==e.length-1&&d==0){return{node:c,offset:$(c.childNodes).index(m.get(e[f]))}}else{c=m.get(e[f])}}}if(d>0){var j="";do{while(c.nextSibling&&d>this.whitespace.condense(this.whitespace.ltrim(j+this.getNodeText(c))).length){j=j+this.getNodeText(c);c=c.nextSibling}while(c.firstChild&&d<=this.whitespace.condense(this.whitespace.ltrim(j+this.getNodeText(c))).length){c=c.firstChild}}while(c!=c.parentNode.lastChild&&d>this.whitespace.condense(this.whitespace.ltrim(j+this.getNodeText(c))).length);var h=this.getNodeText(c);var b=this.whitespace.ltrim(j+h);if(d>b.length){d=b.length}var n=this.whitespace.uncondenseOffset(b,d)+(j.length+h.length-b.length);n-=j.length;if(n==0){return{node:c.parentNode,offset:$(c.parentNode.childNodes).index(c)}}else{return{node:c,offset:n}}}};Locator.prototype.getRange=function(e,c,a){var f=this.getNodeOffsetFromAddress(e);if(a){f=this.snapForward(f.node,f.offset)}var b=this.getNodeOffsetFromAddress(c);if(a){b=this.snapBackward(b.node,b.offset)}var d=this.rootNode.ownerDocument.createRange();d.setStart(f.node,f.offset);d.setEnd(b.node,b.offset);return d};Locator.prototype.snapForward=function(a,b){if(a.nodeType==NodeType.TEXT_NODE){b=this.whitespace.snapForward(a.data,b)}return{node:a,offset:b}};Locator.prototype.snapBackward=function(a,b){if(a.nodeType==NodeType.TEXT_NODE){b=this.whitespace.snapBackward(a.data,b)}return{node:a,offset:b}};Highlighter=function(a,b){this.settings=jQuery.extend({highlightClass:"h",ignoreClasses:[],tagName:"span",idPrefix:"m",whitespace:undefined},b);this.rootNode=a;this.events={};this.whitespace=new Whitespace(this.settings.whitespace)};Highlighter.prototype.highlight=function(d,a){if(a===undefined){a=""+this.settings.idPrefix+((new Date()).getTime())}var o=document.createRange();o.setStart(d.startContainer,d.startOffset);o.collapse(true);var b=document.createRange();b.setStart(d.endContainer,d.endOffset);b.collapse(true);var j=document.createElement(this.settings.tagName);b.insertNode(j);var h=document.createElement(this.settings.tagName);o.insertNode(h);var m=document.createRange();m.setStartAfter(h);m.setEndBefore(j);var k=this;var n=":input *, :input";if(this.settings.ignoreClasses.length>0){n+=", ."+this.settings.ignoreClasses.join(", .");n+=", ."+this.settings.ignoreClasses.join(" *, .")+" *"}var f=$(m.commonAncestorContainer).find("*").add(m.commonAncestorContainer).not(n).contents().add(m.commonAncestorContainer).filter(function(){if(this.nodeType!=NodeType.TEXT_NODE){return false}if(k.whitespace.isWhitespace(this.data)){return false}var i=document.createRange();i.selectNode(this);if(i.compareBoundaryPoints(CompareRanges.START_TO_START,m)>=0&&i.compareBoundaryPoints(CompareRanges.END_TO_END,m)<=0){return true}else{return false}});f.wrap("<"+this.settings.tagName+' class="'+this.settings.highlightClass+" "+a+'"></span>');var e=$(this.getHighlights(a));e.data("id",a);for(var g in this.events){for(var c in this.events[g]){e.bind(g,this.events[g][c])}}var l=[h.nextSibling,j.nextSibling];$(h).remove();$(j).remove();this.mergeAdjacentText(l);return a};Highlighter.prototype.unhighlight=function(c){var b=this.getHighlights(c);var a=[];b.each(function(){if(this.firstChild!=null){a.push(this.firstChild)}if(this.nextSibling!=null){a.push(this.nextSibling)}$(this).replaceWith(this.childNodes)});this.mergeAdjacentText(a)};Highlighter.prototype.mergeAdjacentText=function(b){for(var c in b){if(b[c]==null||b[c].nodeType!=NodeType.TEXT_NODE){continue}var d=b[c];while(d.nextSibling!=null&&d.nextSibling.nodeType==NodeType.TEXT_NODE){d=d.nextSibling}var e=d.data;var a=[];while(d.previousSibling!=null&&d.previousSibling.nodeType==NodeType.TEXT_NODE){e=d.previousSibling.data+e;a.push(d);d=d.previousSibling}d.data=e;$(a).remove()}};Highlighter.prototype.bindHighlights=function(b,a){if(this.events[b]===undefined){this.events[b]=[]}if(jQuery.inArray(a,this.events[b])==-1){this.events[b].push(a);$(this.settings.tagName+"."+this.settings.highlightClass).bind(b,a)}};Highlighter.prototype.unbindHighlights=function(d,c){if(this.events[d]===undefined){return false}for(var b=0;b<this.events[d].length;b++){var a=this.events[d].shift();if(this.events[d][b]!=c){this.events[d].push(a)}else{$(this.settings.tagName+"."+this.settings.highlightClass).unbind(d,c)}}};Highlighter.prototype.getHighlights=function(a){return $(this.settings.tagName+"."+this.settings.highlightClass+"."+a)};Highlighter.prototype.getId=function(a){return $(a).data("id")};Highlighter.prototype.isHighlighted=function(a){return($(a).closest(this.settings.tagName+"."+this.settings.highlightClass).length>0)};Labeller=function(a){this.settings=jQuery.extend({labelClass:"label",containerClass:"labelcont",highlightClass:"h",whitespace:undefined},a);this.whitespace=new Whitespace(this.settings.whitespace);this.events={}};Labeller.prototype.getLabel=function(a){return $("."+this.settings.containerClass+" > ."+this.settings.labelClass+"."+a)[0]};Labeller.prototype.getAllLabels=function(){return $("."+this.settings.containerClass+" > ."+this.settings.labelClass)};Labeller.prototype.getId=function(a){return $(a).data("id")};Labeller.prototype.label=function(a,e){var g=this.getLabel(a);if(g){return g}if(!e){throw new Error('"highlights" argument is not optional')}g=$('<i class="'+this.settings.labelClass+" "+a+'"></i>')[0];$(g).data("id",a);for(var f in this.events){for(var c in this.events[f]){$(g).bind(f,this.events[f][c])}}var h=$('<b class="'+this.settings.containerClass+'">WAMP</b>')[0];$(e[0]).prepend(h);$(h).empty();$(h).prepend(g);for(var c=0;c<e.length;c++){var j=e[c];do{if(j.previousSibling&&$(j.previousSibling).hasClass(this.settings.containerClass)){var b=$(j.previousSibling);if($(e[c].firstChild).hasClass(this.settings.containerClass)){var d=$(e[c].firstChild);d.prepend(b.contents());b.remove()}else{$(e[c]).prepend(b)}}j=j.parentNode}while($(j).hasClass(this.settings.highlightClass))}return g};Labeller.prototype.unlabel=function(c){var b=this.getLabel(c);if(b){var a=$(b).closest("."+this.settings.containerClass);$(b).remove();if($(a).children().length==0){$(a).remove()}}};Labeller.prototype.bindLabels=function(b,a){if(this.events[b]===undefined){this.events[b]=[]}if(jQuery.inArray(a,this.events[b])==-1){this.events[b].push(a);$("."+this.settings.containerClass+" > ."+this.settings.labelClass).bind(b,a)}};Labeller.prototype.unbindLabels=function(d,c){if(this.events[d]===undefined){return false}for(var b=0;b<this.events[d].length;b++){var a=this.events[d].shift();if(this.events[d][b]!=c){this.events[d].push(a)}else{$("."+this.settings.containerClass+" > ."+this.settings.labelClass).unbind(d,c)}}};Popup=function(d,c){this.settings={};this.isShowing=false;this.settings=jQuery.extend(true,{contentClass:"popup-content",x:"center",y:"center",zIndex:1000,show:{params:{opacity:"show"},duration:100,easing:"linear"},hide:{params:{opacity:"hide"},duration:200,easing:"linear"},constrainToWindow:true,overlayOpacity:0,overlayClass:"popup-overlay",overlayShow:{params:{opacity:"show"},duration:200,easing:"linear"},overlayHide:{params:{opacity:"hide"},duration:200,easing:"linear"}},c);this.content=d;$(this.content).addClass(this.settings.contentClass);$(this.content).css({display:"none",position:"absolute",zIndex:this.settings.zIndex});$(document.body).append(this.content);$(this.content).css({display:"block"});var e=$(this.content).find("*").add(this.content).filter(":input").filter(":visible");$(this.content).css({display:"none"});e.filter(":first, :last").bind("keydown",function(g){if(g.keyCode!=KeyCode.TAB){return}var h=e.filter(":first").get(0);var f=e.filter(":last").get(0);if(g.target==h&&g.shiftKey){setTimeout(function(){$(f).focus()},1);return false}else{if(g.target==f&&!g.shiftKey){setTimeout(function(){$(h).focus()},1);return false}}});if(this.settings.overlayOpacity>0){this.overlay=$("<div></div>").get(0);$(this.overlay).css({position:"fixed",width:"100%",height:"100%",opacity:this.settings.overlayOpacity,top:0,left:0,zIndex:this.settings.zIndex,display:"none"});$(this.overlay).addClass(this.settings.overlayClass);$(document.body).append(this.overlay)}if(typeof document.body.style.maxHeight==="undefined"){if(this.settings.overlayOpacity>0){var a=this;var b=function(f){$(a.overlay).css({position:"absolute",width:$(window).width(),height:$(window).height(),top:$(document).scrollTop(),left:$(document).scrollLeft()})};$(window).resize(b);$(window).scroll(b)}}};Popup.prototype.setPosition=function(b,d){if(b!==undefined){this.settings.x=b}if(d!==undefined){this.settings.y=d}var a=$(this.content).outerHeight(true);switch(this.settings.y){case"top":break;case"center":d=($(window).height()/2)-(a/2);break;case"bottom":break;default:d=this.settings.y}if(this.settings.constrainToWindow){if(d<0){d=0}else{if(d+a>=$(window).height()){d=$(window).height()-a}}}var c=$(this.content).outerWidth(true);switch(this.settings.x){case"left":break;case"center":b=($(window).width()/2)-(c/2);break;case"right":break;default:b=this.settings.x}if(this.settings.constrainToWindow){if(b<0){b=0}else{if(b+c>=$(window).width()){b=$(window).width()-c}}}$(this.content).css({top:$(window).scrollTop()+d,left:$(window).scrollLeft()+b})};Popup.prototype.show=function(a,c){this.setPosition(a,c);if(this.isShowing==false){var b;if(this.settings.overlayOpacity>0){b=this.settings.overlayShow;$(document.body).append(this.overlay);$(this.overlay).animate(b.params,b.duration,b.easing,b.callback)}b=this.settings.show;$(document.body).append(this.content);$(this.content).animate(b.params,b.duration,b.easing,b.callback);this.isShowing=true}$(this).triggerHandler("show")};Popup.prototype.hide=function(){if(this.isShowing){var a=this.settings.hide;$(this.content).animate(a.params,a.duration,a.easing,a.callback);if(this.settings.overlayOpacity>0){a=this.settings.overlayHide;$(this.overlay).animate(a.params,a.duration,a.easing)}this.isShowing=false}$(this).triggerHandler("hide")};Annotations=function(a){this.url=a;this.defaultXMLString="<annotations></annotations>";this.xml=XMLTools.stringToXML(this.defaultXMLString)};Annotations.prototype.load=function(a){if(a===undefined){a=this.url}var b=this;var c=jQuery.ajax({url:a,type:"POST",processData:true,dataType:"text",data:{operation:"load"},success:function(d,h){try{if(d.length==0){d=b.defaultXMLString}var g=XMLTools.stringToXML(d);if($(g).find("parsererror").length>0){throw new Error($(g).find("parsererror")[0].firstChild.data)}b.xml=g;$(b).trigger("loadsuccess")}catch(f){$(b).trigger({type:"loadfailure",errorThrown:f});return null}},error:function(d,f,e){$(b).trigger({type:"loadfailure",XMLHttpRequest:d,textStatus:f,errorThrown:e})}});return c};Annotations.prototype.save=function(a){if(a===undefined){a=this.url}var b=this;var c=jQuery.ajax({url:a,type:"POST",processData:true,dataType:"text",data:{operation:"save",xml:XMLTools.xmlToString($(b.xml).children("annotations").get(0))},success:function(d){try{debug(XMLTools.xmlToString($(b.xml).children("annotations").get(0)));$(b).trigger("savesuccess")}catch(f){$(b).trigger({type:"savefailure",errorThrown:f});debug(f);return null}},error:function(e,f,d){$(b).trigger({type:"savefailure",XMLHttpRequest:XMLHttpRequest,textStatus:f,errorThrown:d})}});return c};Annotations.prototype.setMistake=function(f){if(f.id===undefined||f.start===undefined||f.end===undefined){throw new Error("id/start/end not found")}var d=this.xml.createElement("mistake");$(d).attr("id",f.id);$(d).attr("start",f.start);$(d).attr("end",f.end);if(!f.type){throw new Error("Mistake type not found")}var c=this.xml.createElement("type");$(c).text(f.type);$(d).append(c);var a=this.xml.createElement("correction");$(a).text(f.correction);$(d).append(a);if(f.type=="Others"&&!f.comments){throw new Error('Mistakes of type "Others" must have comments')}var e=this.xml.createElement("comments");$(e).text(f.comments);$(d).append(e);var g=this.getMistake(f.id);if(g){var b=$(this.xml).find("mistake#"+f.id).get(0);b.parentNode.replaceChild(d,b);return g}else{$(this.xml).children("annotations").eq(0).append(d);return null}};Annotations.prototype.getMistake=function(b){var a=$(this.xml).find("mistake#"+b);if(a.length==0){return null}else{return{id:b,start:a.attr("start"),end:a.attr("end"),type:a.find("type").text(),correction:a.find("correction").text(),comments:a.find("comments").text()}}};Annotations.prototype.getAllMistakes=function(){var a=this;var b=[];$(this.xml).find("mistake").each(function(){b.push(a.getMistake($(this).attr("id")))});return b};Annotations.prototype.removeMistake=function(c){var a=$(this.xml).find("mistake#"+c).get(0);if(a){var b=this.getMistake(c);a.parentNode.removeChild(a);return b}else{throw new Error("mistake#"+c+" not found")}};Annotations.prototype.removeAllMistakes=function(){$(this.xml).find("mistake").remove()};