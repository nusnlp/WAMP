Corrector=function(a,b){var c=this;c.annotationsURL=a;c.settings=jQuery.extend({bodyId:"wamp_body",correctionClass:"correction"});c.body=$("#"+c.settings.bodyId)[0];c.annotations=null;c.locator=new Locator(c.body);c.loadAnnotations(c.annotationsURL)};Corrector.prototype.loadAnnotations=function(a){var b=this;b.annotations=new Annotations(a);b.annotations.load();$(b.annotations).bind("loadsuccess",function(c){b.loadAnnotationsComplete()})};Corrector.prototype.loadAnnotationsComplete=function(){var e=this;var d=e.annotations.getAllMistakes();d.sort(function(g,f){return e.compareAddress(g.end,f.end)});var a=100,b=1;var c=(new Date()).getTime();(function(){var f=d.length-1;var h=null;function g(){if(f>=0){if(!(h&&e.compareAddress(d[f].end,h)>0)){e.correct(d[f]);h=d[f].start}f--;setTimeout(g,b)}else{debug("total time: ",(new Date()).getTime()-c-a-(d.length*b))}}setTimeout(g,a)})()};Corrector.prototype.compareAddress=function(e,h){var f=e.split(/[\/.]/);f.shift();var d=h.split(/[\/.]/);d.shift();var c=(f.length>d.length)?d.length:f.length;for(var g=0;g<c;g++){if(Number(f[g])!=Number(d[g])){return Number(f[g])-Number(d[g])}}return f.length-d.length};Corrector.prototype.correct=function(c){var e=this;var b=e.locator.getRange(c.start,c.end,true);var a=e.getOriginalString(b).replace(/\s+/g," ");debug([b.startOffset,b.endOffset,a]);b.extractContents();var d=c.correction.replace(/^\s+/,"").replace(/\s+$/,"");if(d==""){d="&nbsp;"}b.insertNode($('<b class="'+e.settings.correctionClass+'" title="'+a+'">'+d+"</b>")[0])};Corrector.prototype.getOriginalString=function(a){var d=window.getSelection();var b=[];for(var c=0;c<d.rangeCount;c++){b.push(d.getRangeAt(c))}d.removeAllRanges();d.addRange(a);var e=d.toString();d.removeAllRanges();for(var c=0;c<b.length;c++){d.addRange(b[c])}return e};