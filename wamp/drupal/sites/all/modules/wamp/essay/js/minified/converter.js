Converter={};Converter.ok=false;Converter.output="";Converter.convert=function(b,g){var c=this;c.whitespace=new Whitespace();var e=XMLTools.loadXMLDoc(b);var a=0,d=1;var f=(new Date()).getTime();c.ok=false;(function(){var k=$(e).find("instance");var h=0;$("#status").text(h+"/"+k.length+" instances done.");function j(){if(h<k.length){c.convertInstance(k[h]);h++;$("#status").empty();$("#status").append(h+"/"+k.length+" instances done.");$("#status").append($("<br />"));$("#status").append("Time taken: "+(((new Date()).getTime()-f-a-(k.length*d))/1000)+" seconds");setTimeout(j,d)}else{c.ok=true;c.output=XMLTools.xmlToString(e);if(g){g(XMLTools.xmlToString(e))}}}setTimeout(j,a)})()};Converter.convertInstance=function(a){var f=this;var e=$(a).find("context")[0];var h=$("#wamp_body")[0];var d="";for(var c=0;c<e.childNodes.length;c++){d+=XMLTools.xmlToString(e.childNodes[c])}$(h).html(d);$(document.body).append(h);f.locator=new Locator(h);var g=$(a).find("annotation");for(var c=0;c<g.length;c++){f.convertAnnotationSet(g[c],h)}var b=document.createRange();b.selectNode(h);e.parentNode.replaceChild(XMLTools.stringToXML("<context><paragraph>"+f.splitParas(b).join("</paragraph><paragraph>")+"</paragraph></context>").firstChild,e)};Converter.convertAnnotationSet=function(e,b){var c=this;var d=$(e).find("mistake");for(var a=0;a<d.length;a++){c.convertMistake(d[a],b)}};Converter.convertMistake=function(d,a){var g=this;var h=g.locator.getRange($(d).attr("start"),$(d).attr("end"),true);var c=document.createRange();c.setStart(a,0);c.setEnd(h.startContainer,h.startOffset);var b=g.splitParas(c);var j=g.whitespace.ltrim(g.whitespace.condense(b[b.length-1]));d.removeAttribute("start");d.setAttribute("startParagraph",b.length-1);d.setAttribute("startOffset",j.length);c.setEnd(h.endContainer,h.endOffset);var i=g.splitParas(c);var f=g.whitespace.ltrim(g.whitespace.condense(i[i.length-1]));d.removeAttribute("end");d.setAttribute("endParagraph",i.length-1);d.setAttribute("endOffset",f.length);var e=$(d).find("correction")[0];$(e).text(g.whitespace.trim($(e).text()))};Converter.splitParas=function(b){var c=window.getSelection();c.removeAllRanges();c.addRange(b);var d=c.toString();c.removeAllRanges();var a=d.split(/[\r\n]+(?=.+)/);return a};