Function.prototype.inherits=function(a){this.prototype=new a();this.prototype.constructor=this;this._super=a.prototype};BaseUI=function(b,a,e,c){var d=this;d.uiURL=b;d.annotationsURL=a;d.elemIds=jQuery.extend({body:"wamp_body",table:"wamp_table",status:"wamp_status",list:"wamp_list",view:"wamp_view",menu:"wamp_menu",form:"wamp_form"},e);d.classes=jQuery.extend({highlight:"h",active:"active",hover:"hover",labelContainer:"lc",label:"l"},c);d.lastSelectedRange=null;d.activeHighlight={};d.hoverHighlights={};d.body=null;d.status=null;d.menu=null;d.list=null;d.form=null;d.view=null;d.annotations=null;d.whitespace=new Whitespace();d.locator=null;d.highlighter=null;d.labeller=null;d.loadUI(d.uiURL)};BaseUI.prototype.loadUI=function(b){var c=this;if(b){c.uiURL=b}else{b=c.uiURL}var a=$('<div id="wamp_temp"></div>');a.load(b,function(e,f,d){a.children().appendTo(document.body);c.loadUIComplete()})};BaseUI.prototype.loadUIComplete=function(){var a=this;a.setupBody($("#"+a.elemIds.body).get(0));a.setupTable($("#"+a.elemIds.table).get(0));a.setupStatus($("#"+a.elemIds.status).get(0));a.setupMenu($("#"+a.elemIds.menu).get(0));a.setupForm($("#"+a.elemIds.form).get(0));a.setupList($("#"+a.elemIds.list).get(0));a.setupView($("#"+a.elemIds.view).get(0));a.setupLocator(a.body,{normaliseClasses:[a.classes.highlight,"__mozilla-findbar-search"],ignoreClasses:[a.classes.labelContainer]});a.setupHighlighter(a.body,{highlightClass:a.classes.highlight,ignoreClasses:[a.classes.labelContainer],idPrefix:"m"});a.setupLabeller({containerClass:a.classes.labelContainer,labelClass:a.classes.label,highlightClass:a.classes.highlight});a.loadAnnotations(a.annotationsURL)};BaseUI.prototype.loadAnnotations=function(a){var b=this;if(a){b.annotationsURL=a}else{a=b.annotationsURL}$(b.status.content).text("Loading annotations, please wait...");b.status.show($("#wamp_body").offset().left-$(window).scrollLeft(),$("#wamp_body").offset().top-$(window).scrollTop());b.annotations=new Annotations(a);b.annotations.load();$(b.annotations).bind("loadsuccess",function(c){b.loadAnnotationsComplete()});$(b.annotations).bind("loadfailure",function(c){b.status.show($("#wamp_body").offset().left-$(window).scrollLeft(),$("#wamp_body").offset().top-$(window).scrollTop());$(b.status.content).text("Loading failed (>_<). What to do?");debug(c.errorThrown)})};BaseUI.prototype.loadAnnotationsComplete=function(){var c=this;var e=c.annotations.getAllMistakes();var a=100,b=1;var d=(new Date()).getTime();(function(){var f=0;function g(){if(e.length>0){c.markMistake(e[f]);f++}if(f<e.length){setTimeout(g,b)}else{debug("total time: ",(new Date()).getTime()-d-a-(e.length*b));c.status.hide()}}setTimeout(g,a)})()};BaseUI.prototype.setupLocator=function(b,a){var c=this;c.locator=new Locator(b,a)};BaseUI.prototype.setupHighlighter=function(b,a){var c=this;c.highlighter=new Highlighter(b,a)};BaseUI.prototype.setupLabeller=function(a){var b=this;b.labeller=new Labeller(a)};BaseUI.prototype.setupBody=function(a){var b=this;b.body=a};BaseUI.prototype.setupTable=function(b){var a=this;a.table=b;$(a.table).remove()};BaseUI.prototype.setupStatus=function(b){var a=this;a.status=new Popup(b,{constrainToWindow:false,overlayOpacity:0.8});$(a.status).bind("show",function(c){$(window).triggerHandler("resize")});$(window).bind("resize",function(c){$(a.status.overlay).css({position:"absolute",background:"#666666",left:$("#wamp_body").offset().left,top:$("#wamp_body").offset().top,width:$("#wamp_body").outerWidth(false),height:$("#wamp_body").outerHeight(false)})})};BaseUI.prototype.setupMenu=function(b){var a=this;a.menu=new Popup(b)};BaseUI.prototype.setupForm=function(a){var b=this;b.form=new Popup(a,{overlayOpacity:0.5,constrainToWindow:false})};BaseUI.prototype.setupView=function(a){var b=this;b.view=new Popup(a,{overlayOpacity:0.5,contrainToWindow:false})};BaseUI.prototype.setupList=function(a){var b=this;b.list=new Popup(a)};BaseUI.prototype.markMistake=function(d){var c=this;var e=c.highlighter.getHighlights(d.id);if(e.length==0){var a=c.locator.getRange(d.start,d.end);c.highlighter.highlight(a,d.id);e=c.highlighter.getHighlights(d.id)}e.removeClass(c.classes.active);var b=$(c.labeller.label(d.id,e));b.text(d.type);b.removeClass(c.classes.active)};BaseUI.prototype.unmarkMistake=function(b){var a=this;a.labeller.unlabel(b);a.highlighter.unhighlight(b)};PrintUI=function(c,b,a,d){PrintUI._super.constructor.call(this,c,b,a,d)};PrintUI.inherits(BaseUI);PrintUI.prototype.setupTable=function(b){PrintUI._super.setupTable.call(this,b);var a=this;$(document.body).append(a.table)};PrintUI.prototype.markMistake=function(f){PrintUI._super.markMistake.call(this,f);var e=this;var b=$(e.labeller.getLabel(f.id));b.html('<i class="index"></i><i class="type">'+f.type+"</i>");var g=$(e.table).find("tbody tr."+f.id);if(g.length==0){g=$('<tr class="'+f.id+'"]> <td></td> <td></td> <td></td> <td></td> </tr>');$(e.table).find("tbody").append(g)}g.children("td:eq(1)").text(f.type);g.children("td:eq(2)").text(f.correction);g.children("td:eq(3)").text(f.comments);var h=e.labeller.getAllLabels();var a=h.index(b);g.siblings(":eq("+a+")").before(g);var d=$(e.table).find("tbody tr");for(var c=a;c<h.length;c++){h.eq(c).children(":eq(0)").text((c+1)+".");d.eq(c).children(":eq(0)").text((c+1)+".")}};PrintUI.prototype.unmarkMistake=function(g){var d=this;var b=d.labeller.getLabel(g);var f=d.labeller.getAllLabels();var a=f.index(b);for(var c=a+1;c<f.length;c++){var e=d.labeller.getId(f[c]);$(d.table).find("tbody tr."+e+" td:first").text(c+".");$(d.labeller.getLabel(e)).children(":first").text(c+".")}$(d.table).find("tbody tr."+g).remove();PrintUI._super.unmarkMistake.call(this,g)};ViewUI=function(c,b,a,d){ViewUI._super.constructor.call(this,c,b,a,d)};ViewUI.inherits(PrintUI);ViewUI.prototype.setupHighlighter=function(b,a){ViewUI._super.setupHighlighter.call(this,b,a);var c=this;c.highlighter.bindHighlights("mouseover",function(d){var e=c.highlighter.getId(this);$(c.highlighter.getHighlights(e)).addClass(c.classes.hover);$(c.labeller.getLabel(e)).addClass(c.classes.hover);c.hoverHighlights[e]=c.highlighter.getHighlights(e);return true});c.highlighter.bindHighlights("mouseout",function(d){var e=c.highlighter.getId(this);$(c.highlighter.getHighlights(e)).removeClass(c.classes.hover);$(c.labeller.getLabel(e)).removeClass(c.classes.hover);delete c.hoverHighlights[e];return true});c.highlighter.bindHighlights("click",function(d){if(c.whitespace.trim(window.getSelection().toString()).length>0){c.list.hide();return true}else{var e=c.highlighter.getId(this);if(c.highlighter.isHighlighted(this.parentNode)==false||d.isPropagationStopped()){c.list.show(d.pageX-$(window).scrollLeft(),d.pageY-$(window).scrollTop());return false}else{return true}}})};ViewUI.prototype.setupLabeller=function(a){ViewUI._super.setupLabeller.call(this,a);var b=this;b.labeller.bindLabels("mouseover mouseout click",function(d){var c=b.labeller.getId(this);for(var e in b.hoverHighlights){if(e!=c){$(b.highlighter.getHighlights(e)[0]).trigger("mouseout")}}d.stopPropagation();$(b.highlighter.getHighlights(c)[0]).trigger(d)})};ViewUI.prototype.setupBody=function(a){ViewUI._super.setupBody.call(this,a);var b=this;$(document).bind("mousedown keydown",function(c){b.list.hide()})};ViewUI.prototype.setupView=function(a){ViewUI._super.setupView.call(this,a);var b=this;$(b.view).bind("show",function(c){var d=b.annotations.getMistake(b.activeHighlight.id);$("#wamp_view_type").text($('#wamp_form_type option[value="'+d.type+'"]').text());$("#wamp_view_correction").text(d.correction);$("#wamp_view_comments").text(d.comments);$(b.view.content).find(":input").removeAttr("disabled");b.activateMistake(d.id);$(b.view.content).find(':button[name="cancel"]').focus();$(b.view.content).find(".message").text("")});$(b.view.content).find(":button").hide(0).bind("click",function(c){c.preventDefault();if($(this).attr("disabled")){c.stopImmediatePropagation()}else{$(b.view.content).find(":input").attr("disabled","disabled")}});$(b.view.content).find(':button[name="cancel"]').show(0).bind("click",function(c){b.deactivateMistake(b.activeHighlight.id);b.view.hide()});$(b.view.content).bind("mousedown",function(c){$(this).startDrag(c)});$(b.view.content).bind("mouseup",function(c){$(this).stopDrag()});$(b.view.content).find(":input, dd").bind("mousedown",function(c){c.stopPropagation()});$(b.view.overlay).bind("click",function(c){$(b.view.content).find(':button[name="cancel"]').trigger("click")});$(b.view.overlay).bind("keypress",function(c){var d=c.keyCode;switch(d){case KeyCode.ESCAPE:$(b.view.content).find(':button[name="cancel"]').trigger("click");break}})};ViewUI.prototype.setupList=function(a){ViewUI._super.setupList.call(this,a);var b=this;$(b.list.content).bind("click",function(c){c.stopPropagation()});$(b.list).bind("show",function(d){$(b.list.content).empty();for(var f in b.hoverHighlights){var e=b.annotations.getMistake(f);debug(e);var c=$("<div></div>");c.append($("<b>"+$('#wamp_form_type option[value="'+e.type+'"]').text()+"</b>"));c.append("<br />");c.append("<span>"+e.correction+"</span>");c.bind("mouseenter",function(g){$(b.labeller.getLabel($(this).data("id"))).addClass(b.classes.hover);$(this).addClass(b.classes.hover);$(b.highlighter.getHighlights($(this).data("id"))).addClass(b.classes.hover)});c.bind("mouseleave",function(g){$(b.labeller.getLabel($(this).data("id"))).removeClass(b.classes.hover);$(this).removeClass(b.classes.hover);$(b.highlighter.getHighlights($(this).data("id"))).removeClass(b.classes.hover)});c.data("id",f);c.bind("click",function(g){var i=$(this).data("id");$(b.labeller.getLabel(i)).removeClass(b.classes.hover);$(b.highlighter.getHighlights(i)).removeClass(b.classes.hover);var h=b.annotations.getMistake(i);b.activeHighlight={id:i,start:h.start,end:h.end};b.view.show();b.list.hide()});$(b.list.content).append(c)}})};ViewUI.prototype.activateMistake=function(b){var a=this;$(a.highlighter.getHighlights(b)).addClass(a.classes.active);$(a.labeller.getLabel(b)).addClass(a.classes.active)};ViewUI.prototype.deactivateMistake=function(b){var a=this;$(a.highlighter.getHighlights(b)).removeClass(a.classes.active);$(a.labeller.getLabel(b)).removeClass(a.classes.active)};EditUI=function(c,b,a,d){EditUI._super.constructor.call(this,c,b,a,d)};EditUI.inherits(ViewUI);EditUI.prototype.setupBody=function(a){EditUI._super.setupBody.call(this,a);var b=this;$(b.body).bind("mouseup",function(c){if($(c.target).filter(":input, :input *").length>0){return true}if(b.whitespace.trim(window.getSelection().toString()).length>0){b.lastSelectedRange=window.getSelection().getRangeAt(0);if(window.external&&typeof(window.external.AddService)!="undefined"){b.menu.show(c.pageX-$(window).scrollLeft(),c.pageY-$(window).scrollTop()-$(b.menu.content).outerHeight(true))}else{b.menu.show(c.pageX-$(window).scrollLeft(),c.pageY-$(window).scrollTop())}}});$(document).bind("mousedown keydown",function(c){b.menu.hide()})};EditUI.prototype.setupMenu=function(b){EditUI._super.setupMenu.call(this,b);var a=this;$(a.menu.content).bind("click",function(c){c.stopPropagation()});$(a.menu).bind("show",function(c){a.list.hide()});$(a.menu.content).find("a").bind("click",function(c){var d=$(this).attr("href");var h=d.substring(d.indexOf("#")+1);switch(h){case"annotate":if(a.lastSelectedRange){var j=a.lastSelectedRange;var f=a.locator.snapForward(j.startContainer,j.startOffset);var i=a.locator.snapBackward(j.endContainer,j.endOffset);var g=a.locator.getAddressFromNodeOffset(f.node,f.offset);var k=a.locator.getAddressFromNodeOffset(i.node,i.offset);j=a.locator.getRange(g,k);debug([g,k]);var e=a.highlighter.highlight(j);var l="";$(a.highlighter.getHighlights(e)).each(function(){l+=a.whitespace.trim(a.whitespace.condense($(this).text()))});if(l.length>0){a.activeHighlight={id:e,start:g,end:k};a.form.show()}else{a.highlighter.unhighlight(e)}}break;case"cancel":break}a.menu.hide();window.getSelection().removeAllRanges();return false})};EditUI.prototype.setupForm=function(a){EditUI._super.setupForm.call(this,a);var b=this;$(b.form).bind("show",function(c){var d=b.annotations.getMistake(b.activeHighlight.id);if(d){$(b.form.content).find(':input[name="type"]').val(d.type);$(b.form.content).find(':input[name="correction"]').val(d.correction);$(b.form.content).find(':input[name="comments"]').val(d.comments)}else{$(b.form.content).find("form").get(0).reset()}$(b.form.content).data("backup",d);$(b.form.content).find(":input").removeAttr("disabled");b.activateMistake(b.activeHighlight.id);$(b.form.content).find(':input[name="type"]').focus();$(b.form.content).find(".message").text("")});$(b.form).bind("hide",function(c){$(b.form.content).removeData("backup")});$(b.form.content).find(":button").bind("click",function(g){g.preventDefault();if($(this).attr("disabled")){return}$(b.form.content).find(":input").attr("disabled","disabled");$(b.form.content).find(".message").text("");var h=$(this).attr("name");switch(h){case"save":var f=null;try{f=b.annotations.setMistake({id:b.activeHighlight.id,start:b.activeHighlight.start,end:b.activeHighlight.end,type:$(b.form.content).find(':input[name="type"]').val(),correction:$(b.form.content).find(':input[name="correction"]').val(),comments:$(b.form.content).find(':input[name="comments"]').val()});debug(b.annotations.getMistake(b.activeHighlight.id))}catch(i){$(b.form.content).find(":input").removeAttr("disabled");$(b.form.content).find(".message").text(i.message);return}var c=function(e){b.markMistake(b.annotations.getMistake(b.activeHighlight.id));b.form.hide();$(b.annotations).unbind("savesuccess",c);$(b.annotations).unbind("savefailure",d)};var d=function(e){if(f){b.annotations.setMistake(f)}else{b.annotations.removeMistake(b.activeHighlight.id)}if(e.errorThrown&&e.errorThrown.message){$(b.form.content).find(".message").text(e.errorThrown.message)}else{$(b.form.content).find(".message").text("Error saving to server.")}$(b.annotations).unbind("savesuccess",c);$(b.annotations).unbind("savefailure",d)};$(b.annotations).bind("savesuccess",c);$(b.annotations).bind("savefailure",d);b.annotations.save();break;case"cancel":if($(b.form.content).data("backup")){b.deactivateMistake(b.activeHighlight.id)}else{b.highlighter.unhighlight(b.activeHighlight.id)}b.form.hide();break}return false});$(b.form.content).bind("mousedown",function(c){$(this).startDrag(c)});$(b.form.content).bind("mouseup",function(c){$(this).stopDrag()});$(b.form.content).find(":input").bind("mousedown",function(c){c.stopPropagation()});$(b.form.overlay).bind("click",function(c){$(b.form.content).find(':button[name="cancel"]').trigger("click")});$(b.form.overlay).bind("keypress",function(c){var d=c.keyCode;switch(d){case 27:$(b.form.content).find(':button[name="cancel"]').trigger("click");break}})};EditUI.prototype.setupView=function(a){EditUI._super.setupView.call(this,a);var b=this;$(b.view.content).find(':button[name="edit"]').show(0).bind("click",function(c){b.view.hide();b.form.show()});$(b.view.content).find(':button[name="delete"]').show(0).bind("click",function(f){var e=b.annotations.removeMistake(b.activeHighlight.id);var c=function(g){b.unmarkMistake(b.activeHighlight.id);b.view.hide();$(b.annotations).unbind("savesuccess",c);$(b.annotations).unbind("savefailure",d)};var d=function(g){if(e){b.annotations.setMistake(e)}if(g.errorThrown&&g.errorThrown.message){$(b.view.content).find(".message").text(g.errorThrown.message)}else{$(b.view.content).find(".message").text("Error saving to server.")}$(b.annotations).unbind("savesuccess",c);$(b.annotations).unbind("savefailure",d)};$(b.annotations).bind("savesuccess",c);$(b.annotations).bind("savefailure",d);b.annotations.save()})};
